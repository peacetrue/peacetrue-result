= 核心原理

//@formatter:off

== 数据结构

响应结果的数据结构如下：

[[Result]]
.响应结果
|===
|名称 |类型 |描述 |备注

|code
|字符串
|编码
|指示返回结果的状态，调用者可根据此字段做业务逻辑判断，进而决定下一动作

|message
|字符串
|描述
|操作失败时，调用者能够根据此字段准确定位失败原因

|data
|任意类型
|数据
|成功时为具体的业务逻辑数据；失败时为引发失败的相关属性
|===

请求参数的数据结构如下：

[[Parameter]]
.请求参数
|===
|名称 |类型 |描述 |备注

|name
|字符串
|名称
|参数的名称

|type
|类型
|类型
|接口实际需要的类型

|value
|字符串
|值
|调用接口时，传入的参数值
|===

== 工作流程

.响应结果的处理流程
[plantuml,target=activity-diagram,format=png]
....
@startuml
start
if (请求是否异常?) then (是)
  :全局捕获控制器异常;
    note left: Filter 异常暂不处理
  :转换异常为响应结果;
    note left: 涉及异常转换体系
  :分类响应结果编码;
    note left: 涉及编码分类体系
else (否)
  :封装为成功响应结果;
endif
:响应结果自定义;
note left
调整返回的属性名，比如：message 改为 msg
添加新属性，比如：success、requestId
end note

stop
@enduml
....

== 响应结果分类

|===
|编码 |通用描述 |具化描述模板 |具化描述模板参数 |备注

|success
|操作成功
|
|
|

|resource_not_found
|请求资源不存在
|请求资源'{0}'不存在
|数组
|数组第一个元素为资源路径

|failure
|操作失败
|
|
|不确定具体失败原因时使用

|errors
|多项错误
|共'#{#root.size()}'项错误
|<<Result>> 集合
|上层指示错误数，具体错误在数据中体现

|parameter_error
|参数错误
|
|
|不确定参数错误的具体原因时使用

|parameter_missing
|缺少参数
|缺少必须的参数'#{name}'
|<<Parameter>>
|请求时没有传入必须的参数

|parameter_invalid
|参数无效
|参数'#{name}'的值'#{value}'不是'#{type}'类型
|<<Parameter>>
|请求时传入的参数无法转换成后台需要的类型，比如：传入的字符 'h' 无法被转换为数值

|parameter_illegal
|参数非法
|参数'#{name}'的值'#{value}'非法
|<<Parameter>>
|请求时传入的参数不满足校验规则，比如：传入的数字 '10' 不在要求的 [0,3] 之间
|===

NOTE: 具化描述模板支持使用 *索引占位符* 和 *SPEL 表达式*。

== 异常转换体系

组件包含一套异常转换体系，用于将异常转换为响应结果，整体结构与 Spring 的转换体系类似。

.异常转换体系抽象结构
image::exception-convert-system.png[]

与 Spring 转换体系对比：

* ExceptionConvertService 对应 Spring 中 ConversionService
* ExceptionConverter 对应 Spring 中 Converter
* ConditionalExceptionConverter 对应 Spring 中 ConditionalGenericConverter
* FallbackExceptionConverter 用于兜底，避免存在无法转换的情况，直接返回 *操作失败*

异常转换器命名规范：推荐使用 *异常类名* + *Converter*。

异常转换器的主要任务包括：

. 确定编码
. 提供具化描述模板
. 提供具化描述模板参数

目前已包含的具体异常转换器：

* MissingServletRequestParameterExceptionConverter
* MissingPathVariableExceptionConverter
* MethodArgumentTypeMismatchExceptionConverter
* BindExceptionConverter
* HttpMessageNotReadableExceptionConverter
* MethodArgumentConversionNotSupportedExceptionConverter
* TypeMismatchExceptionConverter
* MethodArgumentNotValidExceptionConverter

如果有需要，可以将底层编码（直接由异常转换器提供的编码）提供给调用者；
通常情况下，底层编码对调用者帮助不大，而且种类太多，让人困惑。
此时，可以将底层编码分类到上层编码下。
与此同时，仍然保留使用底层编码和描述模版的能力。

.编码分类
* errors: Bind
* parameter_missing: MissingServletRequestParameter、MissingPathVariable
* parameter_invalid：MethodArgumentTypeMismatch、 MethodArgumentTypeMismatch、TypeMismatch、JsonParse、InvalidFormat

